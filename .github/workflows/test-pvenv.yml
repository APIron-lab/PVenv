name: PVenv CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    name: Pester on Windows (${{ matrix.psname }})
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - psname: "PS 5.1"
            shell: powershell
          - psname: "PS 7.4"
            shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install NuGet provider (CurrentUser)
        shell: ${{ matrix.shell }}
        run: |
          Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force -Scope CurrentUser

      - name: Install Pester 5.x (CurrentUser)
        shell: ${{ matrix.shell }}
        run: |
          Install-Module Pester -Scope CurrentUser -Force -SkipPublisherCheck -MinimumVersion 5.0
          Import-Module Pester -MinimumVersion 5.0 -Force

      - name: Set execution policy (Process)
        shell: ${{ matrix.shell }}
        run: Set-ExecutionPolicy -Scope Process -ExecutionPolicy RemoteSigned

      - name: Run tests (${{ matrix.psname }})
        shell: ${{ matrix.shell }}
        run: |
          Import-Module Pester -Force
          $cfg = New-PesterConfiguration
          $cfg.Run.Path = 'PVenv.Tests.ps1'            # ← 相対パス（リポジトリ内）
          $cfg.Output.Verbosity = 'Detailed'
          $cfg.Run.Exit = $true
          Invoke-Pester -Configuration $cfg

      - name: Generate Test Results (JUnit)
        if: always()
        shell: ${{ matrix.shell }}
        run: |
          Import-Module Pester -Force
          $cfg = New-PesterConfiguration
          $cfg.Run.Path = 'PVenv.Tests.ps1'
          $cfg.TestResult.Enabled = $true
          $cfg.TestResult.OutputFormat = 'JUnitXml'
          $cfg.TestResult.OutputPath = "TestResults_${{ matrix.psname }}.xml"
          $cfg.Output.Verbosity = 'Normal'
          try { Invoke-Pester -Configuration $cfg } catch { Write-Warning $_ }
        continue-on-error: true

      - name: Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pester-results-${{ matrix.psname }}
          path: TestResults_${{ matrix.psname }}.xml
          if-no-files-found: ignore

  coverage:
    name: Code Coverage (PS 5.1)
    runs-on: windows-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Pester
        shell: powershell
        run: |
          Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force -Scope CurrentUser
          Install-Module Pester -Scope CurrentUser -Force -SkipPublisherCheck -MinimumVersion 5.0
          Import-Module Pester -Force

      - name: Run tests with coverage (JaCoCo)
        shell: powershell
        run: |
          Import-Module Pester -Force
          $cfg = New-PesterConfiguration
          $cfg.Run.Path = 'PVenv.Tests.ps1'
          $cfg.CodeCoverage.Enabled = $true
          $cfg.CodeCoverage.Path = 'pvenv.ps1'          # ← 対象スクリプト（相対パス）
          $cfg.CodeCoverage.OutputFormat = 'JaCoCo'
          $cfg.CodeCoverage.OutputPath = 'coverage.xml'
          $cfg.Output.Verbosity = 'Normal'
          Invoke-Pester -Configuration $cfg

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}
